@model Asistencia.Models.ViewModels.EvaluationConfigViewModel
@{
    ViewData["Title"] = "Configuración de Evaluaciones";
    // Colores para la barra de estado
    var totalWeight = Model.TotalWeightAllocated;
    var statusColor = totalWeight == 100 ? "bg-success" : (totalWeight > 100 ? "bg-danger" : "bg-warning");
    var statusIcon = totalWeight == 100 ? "fa-check-circle" : "fa-exclamation-triangle";
}
<div class="container-fluid bg-light min-vh-100 pb-5">
    <div class="row pt-4 pb-3 px-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")" class="text-decoration-none">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Admin", "Course")" class="text-decoration-none">Cursos</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Details", "Course", new { courseId = @Model.CourseId })" class="text-decoration-none">#1</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Evaluaciones</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="fw-bold text-dark mb-0">Configuración de Evaluaciones</h3>
                    <p class="text-muted mb-0"><strong class="text-primary">@Model.CourseName</strong></p>
                </div>
                <div>
                    <a href="@Url.Action("Details", "Course", new { courseId = @Model.CourseId })" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Curso
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="row px-3 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle __statusColor bg-warning bg-opacity-10 p-3 me-3 text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas  fa-lg text-warning @(totalWeight == 100 ? "text-success" : (totalWeight > 100 ? "text-danger" : "text-warning"))"></i>
                            <i class="fas @statusIcon fa-2xl text-warning"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-0">Distribución de Nota Final</h6>
                            <small class="text-muted">La suma de los cortes debe ser exactamente 100%.</small>
                        </div>
                    </div>
                    <div class="flex-grow-1 mx-5 d-none d-md-block">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span>Progreso</span>
                            <span class=""> @totalWeight % / 100%</span> <!-- defin la clase de span:(totalWeight == 100 ? "text-success" : "text-dark") --> 
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar @statusColor progress-bar-striped progress-bar-animated" role="progressbar" style="width: @($"{totalWeight}")%;"></div> <!-- color progressbar _statusColor, anchura widgt: totalWeight -->
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="createNewTerm()" data-bs-toggle="modal" data-bs-target="#">
                            <i class="fas fa-plus-circle me-2"></i>Agregar Corte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row px-3 g-4">
        @if (Model.Terms != null && Model.Terms.Any())
        {
            @foreach(var term in Model.Terms){
                <div class="col-lg-6 col-xl-4">
                    <div class="card h-100 border-0 shadow-sm card-hover-effect">
                        
                        <div class="card-header bg-white py-3 border-bottom-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="fw-bold text-dark mb-1">@term.Name</h5>
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">
                                        Valor Final: @term.WeightOnFinalGrade%
                                    </span>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v text-muted"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                        <li><a class="dropdown-item" href="#" onclick="editTerModal()"><i class="fas fa-edit me-2 text-primary"></i>Editar Configuración</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteTerm(@term.TermId)"><i class="fas fa-trash me-2"></i>Eliminar Corte</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            @{
                            // Calculamos cuánto queda disponible en el acumulado
                            var usedAcc = term.Assignments.Where(a => !a.IsExam).Sum(a => a.MaxPoints);
                            var remainingAcc = term.AccumulatedWeight - usedAcc;
                            }
                            <div class="p-3 border-top border-bottom bg-light bg-gradient position-relative" style="min-height: 180px;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-primary me-2">A</span>
                                        <h6 class="fw-bold text-primary mb-0">Acumulado (@usedAcc / @term.AccumulatedWeight)</h6>
                                    </div>
                                    @if(remainingAcc > 0)
                                    {
                                        <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="addAssignment(@term.TermId, false)">
                                            <i class="fas fa-plus-circle"></i> Agregar
                                        </button>
                                    }
                                    else {
                                        <span class="badge bg-secondary text-white" style="font-size: 0.7rem">Completo</span>
                                    }
                                </div>
                                <div class="bg-white rounded border shadow-sm p-0 overflow-hidden">
                                    @{ var accumTasks = term.Assignments.Where(a => !a.IsExam).ToList(); }
                                    @if (accumTasks.Any())
                                    {
                                        <ul class="list-group list-group-flush small">
                                            @foreach(var task in accumTasks)
                                            {
                                                <li class="list-group-item d-flex justify-content-between align-items-center px-3 py-2 border-bottom-0">
                                                    <div class="text-truncate me-2" style="max-width: 160px;" title="@task.Title">
                                                        <i class="fas fa-tasks text-muted me-2" style="font-size: 0.7rem;"></i> @task.Title
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <span class="fw-bold text-dark bg-light px-2 rounded">@task.MaxPoints pts</span>
                                                        <button class="btn btn-sm btn-link text-primary p-0 me-2 hover-opacity-100" 
                                                                onclick="editAssignment(@task.AssignmentId)" 
                                                                title="Editar">
                                                                <i class="fas fa-pencil-alt"></i>
                                                        </button>
                                                            <button class="btn btn-sm btn-link text-danger p-0 opacity-50 hover-opacity-100" 
                                                                onclick="deleteAssignment(@task.AssignmentId)" 
                                                                title="Eliminar actividad">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    }else{
                                        <div class="text-center py-4 text-muted">
                                            <i class="fas fa-box-open mb-2 opacity-25" style="font-size: 1.5rem;"></i>
                                            <p class="small mb-0">Sin asignaciones</p>
                                        </div>
                                    }
                            </div>
                        </div>
                        <div class="p-3 bg-white position-relative" style="min-height: 120px;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-danger me-2">E</span>
                                        <h6 class="fw-bold text-danger mb-0">Examen (@term.ExamWeight%)</h6>
                                    </div>
                                </div>
                                @{ var examTask = term.Assignments.FirstOrDefault(a => a.IsExam); }
                                @if (examTask != null)
                                {
                                   <div class="alert alert-danger d-flex justify-content-between align-items-center p-2 mb-0 border-danger border-opacity-25 bg-danger bg-opacity-10">
            
            <div class="d-flex align-items-center text-truncate" style="max-width: 70%;">
                <div class="rounded-circle bg-white text-danger d-flex justify-content-center align-items-center me-2 border border-danger border-opacity-25" style="width: 32px; height: 32px; min-width: 32px;">
                    <i class="fas fa-file-signature"></i>
                </div>
                <div>
                    <strong class="text-danger d-block text-truncate" title="@examTask.Title">@examTask.Title</strong>
                    <small class="text-danger opacity-75" style="font-size: 0.7rem;">Vence: @(examTask.DueDate?.ToString("dd/MM") ?? "S/F")</small>
                </div>
            </div>
            
            <div class="d-flex align-items-center">
                <span class="badge bg-white text-danger border border-danger me-2 shadow-sm">
                    @examTask.MaxPoints pts
                </span>
                <button class="btn btn-sm btn-link text-danger p-0 me-2 hover-opacity-100" 
                    onclick="editAssignment(@examTask.AssignmentId)" 
                    title="Editar Examen">
                    <i class="fas fa-pencil-alt fa-lg"></i>
                </button>
                <button class="btn btn-sm btn-link text-danger p-0 opacity-50 hover-opacity-100" 
                        onclick="deleteAssignment(@examTask.AssignmentId)"
                        title="Eliminar Examen">
                    <i class="fas fa-trash-alt fa-lg"></i>
                </button>
            </div>
        </div>
                                }
                                else
                                {
                                    <button class="btn btn-outline-danger w-100 border-dashed py-3 opacity-75" onclick="addAssignment(@term.TermId, true)">
                                        <i class="fas fa-plus me-1"></i> Definir Examen
                                    </button>
                                }
                        </div>
                    </div>
                    @{
                        // 1. CORRECCIÓN: Sumamos los puntos de las tareas REALES creadas (Acumulado + Examen)
                        var totalAssigned = term.Assignments.Sum(a => a.MaxPoints);
    
                        // 2. Lógica visual
                        var isComplete = totalAssigned == 100;
                        var isOver = totalAssigned > 100; // Por si acaso hay error de validación
    
                        // 3. Estilos dinámicos
                        // Verde = 100%, Rojo = Se pasó, Naranja/Amarillo = Falta
                        var footerColor = isComplete ? "text-success" : (isOver ? "text-danger" : "text-warning");
                        var footerBg = isComplete ? "bg-success bg-opacity-10" : (isOver ? "bg-danger bg-opacity-10" : "bg-warning bg-opacity-10");
                        var footerIcon = isComplete ? "fa-check-circle" : (isOver ? "fa-exclamation-triangle" : "fa-chart-pie");
                        var statusText = isComplete ? "Planificación Completa" : (isOver ? "Excede el 100%" : "Faltan Puntos");
                    }
                        <div class="card-footer bg-white py-2 text-center border-top">
                            <small class="fw-bold @footerColor" style="font-size: 0.7rem;">
                                <i class="fas @footerColor me-1"></i>
                                @statusText
                            </small>
                            <small class="fw-bold text-dark" style="font-size: 0.75rem;">
                                <strong>@totalAssigned%</strong> / 100%
                            </small>
                        </div>
                        <div class="progress mt-1 bg-white" style="height: 4px;">
                            <div class="progress-bar @(isOver ? "bg-danger" : (isComplete ? "bg-success" : "bg-warning"))" 
                                role="progressbar" 
                                style="width: @(totalAssigned > 100 ? 100 : totalAssigned)%;">
                            </div>
                        </div>
                    </div>
                </div>
            }
        }else{
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-3">
                         <i class="fas fa-layer-group fa-2xl text-secondary opacity-50"></i>
                    </div>
                    <h4 class="fw-bold text-dark">No hay cortes configurados</h4>
                    <p class="text-muted">Comienza definiendo la estructura de evaluación (ej: I Parcial, II Parcial).</p>
                    <button class="btn btn-primary mt-2" onclick="createNewTerm()">
                        <i class="fas fa-plus me-2"></i> Crear Primer Corte
                    </button>
                </div>
            </div>
        }
    </div>
</div>
<!-- Assigment Add Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-white">
                <h5 class="modal-title fw-bold" id="modalTitle">Nueva Asignación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="assignmentForm">
                    <input type="hidden" id="termId">
                    <input type="hidden" id="isExam">

                    <div id="typeAlert" class="alert d-flex align-items-center mb-4" role="alert">
                        <i id="alertIcon" class="fas fa-info-circle fa-lg me-3"></i>
                        <div>
                            <strong id="alertTitle" class="d-block">Tipo de Actividad</strong>
                            <small id="alertDesc">Descripción del contexto.</small>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="taskTitle" placeholder="Título" required>
                        <label for="taskTitle">Título de la actividad</label>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control fw-bold" id="maxPoints" placeholder="Puntos" value="10" min="1" max="100">
                                <label for="maxPoints">Puntaje Máximo</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="dueDate">
                                <label for="dueDate">Fecha Límite</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating">
                        <textarea class="form-control" placeholder="Descripción" id="description" style="height: 100px"></textarea>
                        <label for="description">Descripción (Opcional)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                <button type="button"id="btnSaveAssignment"  class="btn btn-primary px-4 rounded-pill" onclick="saveAssignment()">Guardar Actividad</button>
            </div>
        </div>
    </div>
</div>
<!-- Add Term Modal -->
<div class="modal fade" id="createTermModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            
            <div class="modal-header bg-white border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Configurar Nuevo Corte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-4">
                <form id="createTermForm">
                    <h6 class="text-muted text-uppercase small fw-bold mb-3">Datos Generales</h6>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="termName" placeholder="Nombre" required>
                        <label for="termName">Nombre del Corte (Ej: I Parcial)</label>
                    </div>

                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between">
                            <span class="fw-bold">Valor del Corte (Nota Final)</span>
                            <span class="badge bg-success bg-opacity-10 text-success" id="availableWeightBadge">
                                Disponible: <span id="availableWeightVal">0</span>%
                            </span>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control fw-bold" id="termWeight" value="30" min="1" max="100">
                            <span class="input-group-text bg-light fw-bold">%</span>
                        </div>
                        <div class="form-text small">Porcentaje que este corte representa en la nota final del curso.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Vigencia Académica</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">Del</span>
                            <input type="date" class="form-control" id="et_StartDate">
                            <span class="input-group-text bg-light">Al</span>
                            <input type="date" class="form-control" id="et_EndDate">
                        </div>
                    </div>

                    <hr class="text-muted opacity-25 my-4">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Distribución Interna (100%)</h6>
                        <small class="text-muted"><i class="fas fa-balance-scale"></i> Ajuste Automático</small>
                    </div>

                    <div class="p-3 bg-light rounded border">
                        <div class="progress mb-3" style="height: 12px;">
                            <div class="progress-bar bg-primary" role="progressbar" id="barAccumulated" style="width: 60%"></div>
                            <div class="progress-bar bg-danger" role="progressbar" id="barExam" style="width: 40%"></div>
                        </div>

                        <input type="range" class="form-range mb-3" id="distributionRange" min="0" max="100" step="5" value="60">

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-primary fw-bold mb-1">Acumulado</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-primary text-white border-primary"><i class="fas fa-layer-group"></i></span>
                                    <input type="number" class="form-control fw-bold text-primary" id="accumWeight" value="60" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="small text-danger fw-bold mb-1">Examen</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-danger text-white border-danger"><i class="fas fa-file-alt"></i></span>
                                    <input type="number" class="form-control fw-bold text-danger" id="examWeight" value="40" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                <button type="button" class="btn btn-light text-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary px-4 shadow-sm" onclick="submitNewTerm()">
                    <i class="fas fa-save me-2"></i>Guardar Corte
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Term Edit Modal -->
<div class="modal fade" id="editTermModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            
            <div class="modal-header bg-warning bg-opacity-10 text-dark border-bottom-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-calendar-check me-2 text-warning"></i>Editar Corte : <span id="editModalTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-4">
                <form id="editTermForm">
                    <input type="hidden" id="et_TermId" />

                    <div class="row g-3 mb-3">
                        <div class="col-8">
                            <label class="form-label small fw-bold text-muted">Nombre del Corte</label>
                            <input type="text" class="form-control fw-bold" id="et_Name" placeholder="Ej: I Parcial">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold text-muted">Valor (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control fw-bold text-center" id="et_Weight" min="1" max="100" value="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Vigencia Académica</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">Del</span>
                            <input type="date" class="form-control" id="et_StartDate">
                            <span class="input-group-text bg-light">Al</span>
                            <input type="date" class="form-control" id="et_EndDate">
                        </div>
                    </div>
                     <div class="alert alert-light border d-flex align-items-start small text-muted mb-0">
                        <i class="fas fa-info-circle text-primary mt-1 me-2"></i>
                        <div>
                            <strong>Nota:</strong> Las fechas definen qué estudiantes se consideran "Activos" en los reportes estadísticos. El porcentaje recalculará el promedio final automáticamente.
                        </div>
                    </div>

                     <hr class="text-muted opacity-25 my-4">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Distribución Interna (100%)</h6>
                        <small class="text-muted"><i class="fas fa-balance-scale"></i> Ajuste Automático</small>
                    </div>

                    <div class="p-3 bg-light rounded border">
                        <div class="progress mb-3" style="height: 12px;">
                            <div class="progress-bar bg-primary" role="progressbar" id="barAccumulated" style="width: 60%"></div>
                            <div class="progress-bar bg-danger" role="progressbar" id="barExam" style="width: 40%"></div>
                        </div>

                        <input type="range" class="form-range mb-3" id="distributionRange" min="0" max="100" step="5" value="60">

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-primary fw-bold mb-1">Acumulado</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-primary text-white border-primary"><i class="fas fa-layer-group"></i></span>
                                    <input type="number" class="form-control fw-bold text-primary" id="accumWeight" value="60" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="small text-danger fw-bold mb-1">Examen</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-danger text-white border-danger"><i class="fas fa-file-alt"></i></span>
                                    <input type="number" class="form-control fw-bold text-danger" id="examWeight" value="40" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                   
                </form>
            </div>

            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-link text-decoration-none text-muted" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-dark px-4" onclick="saveTermChanges()">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    @{await Html.RenderPartialAsync("_Scripts");}
    
    <style>
        .card-hover-effect {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }
        .border-dashed {
            border-style: dashed !important;
            border-width: 2px !important;
        }
        /* Contenedor con scroll */
.gradebook-container {
    overflow: auto;
    position: relative;
}

/* Columna Izquierda Congelada (Nombres) */
.sticky-col-left {
    position: sticky;
    left: 0;
    z-index: 5;
    background-color: #fff; /* Tapar contenido al scrollear */
    box-shadow: 2px 0 5px rgba(0,0,0,0.05); /* Sombra sutil divisoria */
}

/* Nota Final Congelada a la Derecha (Opcional, pero útil) */
.sticky-col-right {
    position: sticky;
    right: 0;
    z-index: 5;
}

/* Input limpio que parece texto hasta que le das click */
.grade-input:focus {
    background-color: #fff !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
.grade-input::-webkit-inner-spin-button, 
.grade-input::-webkit-outer-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
}
input[type=number] {
  -moz-appearance: textfield;
}
    </style>
}