<script>
    document.addEventListener('DOMContentLoaded', () => {
            addScheduleRow();
            document.getElementById('courseHours').addEventListener('input', updateAcademicCalculation);
            document.getElementById('courseCareer').addEventListener('change', e =>{
            if(this.selectedIndex != 0){
                disableInputs(false);
                loadSubjects();
            }else{
                disableInputs(true);
            }
            });
            document.getElementById('btnClose').addEventListener('click', cancelcourseModal);
            document.getElementById('courseSubjectr').addEventListener('change', e =>{
                if(document.getElementById('courseSubjectr').selectedIndex != 0){
                    loadSubjectCredit();
                }
            });
        });
        // Función para agregar una fila de horario
        function addScheduleRow() {
            const container = document.getElementById('scheduleContainer');
            const emptyMsg = document.getElementById('emptyScheduleMsg');
            if(!container){
                Swal.fire({
                    title: 'Error!',
                    text: 'No se contro schedulecontainer',
                    icon: 'error',
                    confirmButtonText: 'Ok'
                })
            }
            // Ocultar mensaje de vacío
            if(emptyMsg) emptyMsg.style.display = 'none';
            // Crear ID único para la fila
            const rowId = 'row-' + Date.now();
            const htmlRow = `
                <div class="row g-2 mb-2 schedule-row align-items-center" id="${rowId}">
                    <div class="col-4 col-md-4">
                        <div class="form-floating">
                            <select class="form-select schedule-day" required>
                                <option value="" selected disabled>Día</option>
                                <option value="1">Lunes</option>
                                <option value="2">Martes</option>
                                <option value="3">Miércoles</option>
                                <option value="4">Jueves</option>
                                <option value="5">Viernes</option>
                                <option value="6">Sábado</option>
                                <option value="7">Domingo</option>
                            </select>
                            <label>Día</label>
                        </div>
                    </div>
                    <div class="col-3 col-md-3">
                        <div class="form-floating">
                            <input type="time" class="form-control schedule-start" required>
                            <label>Inicio</label>
                        </div>
                    </div>
                    <div class="col-3 col-md-3">
                        <div class="form-floating">
                            <input type="time" class="form-control schedule-end" required>
                            <label>Fin</label>
                        </div>
                    </div>
                    <div class="col-2 col-md-2 text-center">
                        <button type="button" class="btn btn-outline-danger btn-delete-row w-100" onclick="removeRow('${rowId}')" title="Eliminar horario">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', htmlRow);
            const newRow = document.getElementById(rowId);
            newRow.querySelector('.schedule-start').addEventListener('change', updateAcademicCalculation);
            newRow.querySelector('.schedule-end').addEventListener('change', updateAcademicCalculation);
            updateAcademicCalculation();
        }
        function updateScheduleCount(){
            const rowCount = document.querySelectorAll('.schedule-row').length;
            const counterEl = document.getElementById('currentAcademicHours');
            const freqInput = document.getElementById('courseHours');
            if(counterEl) counterEl.innerText = rowCount;
            // (Opcional) Cambiar color si coincide o no
            if(freqInput && freqInput.value) {
                const targetFreq = parseInt(freqInput.value);
                if(rowCount === targetFreq) {
                    counterEl.className = "fw-bold text-success"; // Verde si coincide
                } else if (rowCount > targetFreq) {
                    counterEl.className = "fw-bold text-danger"; // Rojo si se pasó
                } else {
                    counterEl.className = "fw-bold text-warning"; // Amarillo si falta
            }
        }
        }
         // Función para eliminar fila
        function removeRow(rowId) {
            const row = document.getElementById(rowId);
            if(row) row.remove();
            // Si no quedan filas, mostrar mensaje
            const container = document.getElementById('scheduleContainer');
            if (container.children.length === 0) {
                document.getElementById('emptyScheduleMsg').style.display = 'block';
            }
            updateAcademicCalculation();
        }
        function updateAcademicCalculation() {
            const freqInput = document.getElementById('courseHours');
            const targetFreq = parseFloat(freqInput.value) || 0;
            // Actualizar visualmente el total de horas por semana
            document.getElementById('targetFrequencyDisplay').innerText = targetFreq;

            let totalRealMinutes = 0;
            const row = document.querySelectorAll('.schedule-row');
            row.forEach(row =>{
                const startInput = row.querySelector('.schedule-start').value;
                const endInput = row.querySelector('.schedule-end').value;
                if( startInput && endInput){
                    const minutes = calculateMinutes(startInput,endInput);
                    if(minutes > 0){
                        totalRealMinutes += minutes;
                    }
                }
            });
            const feedbackEl = document.getElementById('hourFeedback');
            const totalAcademicHours = (totalRealMinutes / 45);
            const displayValue = totalAcademicHours % 1 === 0 ? totalAcademicHours.toFixed(0) : totalAcademicHours.toFixed(1);
            const displayEl = document.getElementById('currentAcademicHours');
            displayEl.innerText = displayValue;
            if(Math.abs(totalAcademicHours - targetFreq) < 0.1 && targetFreq > 0){
                displayEl.className = "fw-bold fs-5 text-success";
                feedbackEl.style.display = 'none';
            }else if(totalAcademicHours > targetFreq){
                displayEl.className = "fw-bold fs-5 text-danger";
                feedbackEl.style.display = 'block';
                feedbackEl.innerText = "Te has pasado de las horas establecidas.";
                return false;
            }else {
                displayEl.className = "fw-bold fs-5 text-warning";
                feedbackEl.style.display = 'none';
                return false;
            }
        }
        function calculateMinutes(startTime, endTime){
            const start = new Date(`1970-01-01T${startTime}:00`);
            const end = new Date(`1970-01-01T${endTime}:00`);
            // diferencias en milesimas 
            let diffMs = end - start;
            if(diffMs <= 0) return 0;
            return Math.floor(diffMs / 1000 / 60);
        }
        async function  registerCourse(){
            const formNewCourse = document.getElementById('registerCourseForm');
            if (!formNewCourse.checkValidity()) {
                formNewCourse.reportValidity(); // Muestra los mensajes nativos del navegador
                return;
            }
            const subjectId = document.getElementById('courseSubjectr').value;
            const semester = document.getElementById('Semester').value;
            const year = document.getElementById('Year').value;
            const shift =document.getElementById('courseShift').value;
            const courseCreditsInput = document.getElementById('courseCredits').value;
            const totalHours = document.getElementById('TotalHours').value;
            const hours =  document.getElementById('courseHours').value;
            const courseCapacity = document.getElementById('courseCapacity').value;
            const classroomId = document.getElementById('courseClassroom').value; 
            const startDate = document.getElementById('courseStartDate').value;
            const endDate = document.getElementById('courseEndDate').value;
            const status = document.getElementById('isActive').checked
            console.log(`classroom Value ${classroomId}`);
            if(!subjectId || !courseCreditsInput || !classroomId || !startDate || !endDate ||
                !semester || !year || !shift || !totalHours  || !hours || !courseCapacity){
                Swal.fire({
                    title: 'Error!',
                    text: `Por favor complete todos los campos obligatorios.\n${subjectId} ${courseCreditsInput} ${classroomId} ${startDate} ${endDate}`,
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
                return;
            }
            // Recolectar Horarios
            const  scheduleRow =document.querySelectorAll('.schedule-row');
            let scheduleList = [];
            let hasError = false;
            scheduleRow.forEach( row =>{
                const day = row.querySelector('.schedule-day').value;
                const startTime = row.querySelector('.schedule-start').value;
                const endTime = row.querySelector('.schedule-end').value;
                if(!day || !startTime || !endTime){
                    hasError = true;
                    return;
                }
                scheduleList.push({
                        DayOfWeek: parseInt(day),
                        StartTime : startTime,
                        EndTime : endTime
                });
            });
            if(scheduleList.length == 0){
                Swal.fire({
                    title : 'Horario Vacio',
                    text: 'Debe de al menos un dia al horario',
                    icon: 'warning'
                });
                return;
            }
            if(hasError){
                Swal.fire({
                    title: 'Horario Incompleto!',
                    text: 'Por favor complete todos los campos de horario.',
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
                return;
            }
            const currentHours = parseFloat(document.getElementById('currentAcademicHours').innerText);
            const targetHours = parseFloat(document.getElementById('courseHours').value);
            if (currentHours !== targetHours) {
                const confirm = await Swal.fire({
                    title: 'Horas no coinciden',
                    text: `Se esperan ${targetHours} horas, pero asignó ${currentHours}. ¿Desea continuar?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, registrar igual'
                });
                if (!confirm.isConfirmed) return;
            }
            // 4. Construir Objeto
            const dataToSend = {
                SubjectId: subjectId,
                Semester: semester, 
                Year: year,
                Shift: shift,
                Credits: courseCreditsInput,
                TotalHours: totalHours,
                HoursPerWeek: hours,
                ClassroomId: classroomId,
                Capacity: parseInt(courseCapacity) || 0,
                StartDate: startDate,
                EndDate: endDate,
                IsActive: document.getElementById('isActive').checked,
                Schedules: scheduleList
            };
            console.log(JSON.stringify(dataToSend));
            try{
                const response = await fetch('/Course/RegisterCourse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getToken()
                    },
                    body : JSON.stringify(dataToSend)
                });
                const result = await response.json();
                if(result.success){
                    Swal.fire({
                        title: 'Éxito!',
                        text: 'Curso registrado correctamente.',
                        icon: 'success',
                        confirmButtonText: 'Ok'
                    });
                    // Cerrar Modal y limpiar formulario
                    const modalElement = document.getElementById('registerCourseModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    modalInstance.hide();
                    cancelcourseModal();
                    location.reload();
                    }else{
                        Swal.fire({
                            title: 'Error!',
                            text: result.message || 'Ocurrió un error al registrar el curso.',
                            icon: 'error',
                            confirmButtonText: 'Ok'
                        });
                    }
            }catch(error){
                console.error('Error al registrar el curso:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Ocurrió un error al registrar el curso.',
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        }
        function disableInputs(value){
            document.getElementById('courseCareer').disabled = value;
            document.getElementById('courseSubjectr').disabled = value;
            document.getElementById('Semester').disabled = value;
            document.getElementById('Year').disabled = value;
            document.getElementById('courseShift').disabled = value;
            document.getElementById('courseCredits').disabled = value;
            document.getElementById('TotalHours').disabled = value;
            document.getElementById('courseHours').disabled = value;
            document.getElementById('courseCapacity').disabled = value;
            document.getElementById('courseClassroom').disabled = value;
            document.getElementById('courseStartDate').disabled = value;
            document.getElementById('courseEndDate').disabled = value;
            document.getElementById('isActive').disabled = value;
        }
        function clearInputs(){
            document.getElementById('courseCareer').selectedIndex = 0;
            document.getElementById('courseSubjectr').value = "";
            document.getElementById('Semester').value = "";
            document.getElementById('Year').value = @DateTime.Now.Year;
            document.getElementById('courseShift').value = "" 
            document.getElementById('courseCredits').value = null;
            document.getElementById('TotalHours').value = null;
            document.getElementById('courseHours').value = null;
            document.getElementById('courseCapacity').value = null;
            document.getElementById('courseClassroom').value = "";
            document.getElementById('courseStartDate').value = "";
            document.getElementById('courseEndDate').value = "";
            document.getElementById('isActive').checked = true ;
        }
        function cancelcourseModal(){
            document.getElementById('courseCareer').selectedIndex = 0;
            clearInputs();
            disableInputs(true);
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            addScheduleRow();
        }
        function loadSubjects()
        {
            const careerSelect = document.getElementById('courseCareer');
            const subjectSelect = document.getElementById('courseSubjectr');
            const careerId = careerSelect.value;
            console.log(`el codigo de carrera es ${careerId}`);
            if (!careerId) {
                subjectSelect.innerHTML = '<option value="" selected disabled>Primero seleccione carrera...</option>';
                return;
            }
            
            fetch(`/Subject/GetSubjectByCareer?careerId=${careerId}`)
                .then( response => {
                   if (!response.ok) throw new Error("Error en servidor");
                    return response.json();
                })
                .then(data =>{
                    if(data.success){
                        subjectSelect.innerHTML = '<option value="" selected disabled>Seleccione Asignatura...</option>';
                        data.data.forEach( subject => {
                            const option = document.createElement('option');
                            option.value = subject.id;
                            option.text = subject.name;
                            subjectSelect.append(option);
                        });
                    }else{
                        Swal.fire('no se cargo las carreras');
                    }
                }
                ).catch(e =>
                    console.error(`Error ${e}`)
                );
        }
            function loadSubjectCredit(){
                const subjectSelect = document.getElementById('courseSubjectr');
                const subjectCredit = document.getElementById('courseCredits');
                if(!subjectSelect || !subjectCredit) return;
                subjectCredit.value = "";
                subjectCredit.placeholder = "Cargando...";
                subjectCredit.disabled = true;
                const url = `@Url.Action("GetSubjectCredit", "Subject" )?subjectId=${subjectSelect.value}`
                fetch(url).then(response => {
                    if(!response.ok){
                       throw new Error("Error al recibir dato del servidor");
                    }
                     return response.json();
                }).then(data =>{
                    subjectCredit.disabled = false;
                    if (data.success) {
                        // Si usaste la Opción 2 del backend (recomendada):
                        if (subjectCredit) {
                        subjectCredit.valueAsNumber = parseInt(data.data.credit); // Asigna el valor al input
                        }
                    } else {
                        console.warn("El servidor respondió success: false");
                        if (subjectCredit) subjectCredit.value = "";
                    }
                });
            }
</script>